<% layout('layout') %>
<h1>Thanh toán</h1>
<form id="checkoutForm" onsubmit="return submitOrder()">
  <label>Chi nhánh</label>
  <select id="branch_id">
    <% branches.forEach(b=>{ %><option value="<%= b.id %>"><%= b.name %></option><% }) %>
  </select>

  <fieldset>
    <legend>Hình thức</legend>
    <label><input type="radio" name="order_type" value="dine-in" checked onchange="toggleOrderType()"> Tại bàn</label>
    <label><input type="radio" name="order_type" value="delivery" onchange="toggleOrderType()"> Giao hàng</label>
  </fieldset>

  <div id="dineInBox">
    <label>Số bàn</label>
    <input id="table_number" placeholder="VD: B12">
  </div>

  <div id="deliveryBox" style="display:none">
    <label>Họ tên</label><input id="delivery_name">
    <label>SĐT</label><input id="delivery_phone">
    <label>Địa chỉ</label><input id="delivery_address">
    <p style="font-size:.9rem;color:#b45309;margin:.3rem 0 0 0;">⚠️ Lưu ý: quán sẽ tính phí ship riêng tuỳ theo nơi</p>
  </div>

  <div class="row">
    <input id="coupon" placeholder="Mã giảm giá (tuỳ chọn)">
    <button class="btn outline" type="button" onclick="applyCoupon()">Áp dụng</button>
  </div>

  <button class="btn">Đặt món</button>
</form>

<script>
function toggleOrderType(){
  const type = document.querySelector('input[name=order_type]:checked').value;
  document.getElementById('dineInBox').style.display = type==='dine-in' ? '' : 'none';
  document.getElementById('deliveryBox').style.display = type==='delivery' ? '' : 'none';
}
async function applyCoupon(){
  const code = document.getElementById('coupon').value.trim();
  await fetch('/api/cart/coupon',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({code})});
  alert('Đã cập nhật mã');
}
async function submitOrder(){
  const payload = {
    branch_id: document.getElementById('branch_id').value,
    order_type: document.querySelector('input[name=order_type]:checked').value,
    table_number: document.getElementById('table_number').value,
    delivery_name: document.getElementById('delivery_name')?.value,
    delivery_phone: document.getElementById('delivery_phone')?.value,
    delivery_address: document.getElementById('delivery_address')?.value
  };
  const r = await fetch('/api/checkout',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
  const j = await r.json();
  if (!j.ok){ alert(j.error||'Lỗi'); return false; }
  alert('Đặt món thành công #' + j.order_id);
  location.href = '/orders';
  return false;
}
</script>
